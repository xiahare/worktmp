/*
{
    "type": "sp_mv",
    "version": "070600.3329",
    "name": "fv_fct_E_endpoint_malware",
    "datasource_mv": "fv_fct_E_endpoint_malware_5min_mv_sp$SPID"
}
*/
DROP TABLE IF EXISTS siem.fv_fct_E_endpoint_malware_5min_mv_sp$SPID;
DROP TABLE IF EXISTS siem.fv_fct_E_endpoint_malware_hour_mv_sp$SPID;
DROP TABLE IF EXISTS siem.fv_fct_E_endpoint_malware_day_mv_sp$SPID;
DROP TABLE IF EXISTS siem.fv_fct_E_endpoint_malware_5min_sp$SPID;
DROP TABLE IF EXISTS siem.fv_fct_E_endpoint_malware_hour_sp$SPID;
DROP TABLE IF EXISTS siem.fv_fct_E_endpoint_malware_day_sp$SPID;

CREATE TABLE IF NOT EXISTS siem.fv_fct_E_endpoint_malware_5min_sp$SPID (
    timescale DateTime, dvid Int32, f_user Nullable(String),
    _adomoid UInt64,
    fgtserial LowCardinality(Nullable(String)),
    emsserial LowCardinality(Nullable(String)),
    fctver Nullable(String),
    subtype LowCardinality(String),
    virus LowCardinality(Nullable(String)),
    file Nullable(String),
    action LowCardinality(Nullable(String)),
    hostname LowCardinality(Nullable(String)),
    srcip_state AggregateFunction(max, Nullable(IPv6)),
    events_state AggregateFunction(sum, Int64)
)
ENGINE = AggregatingMergeTree()
PRIMARY KEY (_adomoid, dvid, timescale, fgtserial, emsserial, virus, file, action, hostname)
ORDER BY (_adomoid, dvid, timescale,
         fgtserial, emsserial, virus, file, action, hostname, fctver, subtype)
PARTITION BY toYYYYMMDD(timescale)
SETTINGS index_granularity = 8192, allow_nullable_key = 1 $STORAGE;

CREATE TABLE IF NOT EXISTS siem.fv_fct_E_endpoint_malware_hour_sp$SPID AS siem.fv_fct_E_endpoint_malware_5min_sp$SPID;

CREATE TABLE IF NOT EXISTS siem.fv_fct_E_endpoint_malware_day_sp$SPID AS siem.fv_fct_E_endpoint_malware_5min_sp$SPID;

CREATE MATERIALIZED VIEW IF NOT EXISTS siem.fv_fct_E_endpoint_malware_5min_mv_sp$SPID
TO siem.fv_fct_E_endpoint_malware_5min_sp$SPID
AS SELECT _adomoid, dvid, fv_timescale_func(itime, 300, 0) AS timescale,
       fgtserial, emsserial,
       virus,
       file,
       action,
       hostname,
       fctver, subtype,
       maxState(deviceip) AS srcip_state,
       sumState(toInt64(events)) AS events_state
       FROM (
           SELECT
               itime,
               dvid,
               _adomoid,
               _devlogtype,
               $LOGFIELD-fgtserial,
               $LOGFIELD-emsserial,
               $LOGFIELD-virus,
               $LOGFIELD-file,
               $LOGFIELD-action,
               $LOGFIELD-hostname,
               $LOGFIELD-fctver,
               subtype,
               $LOGFIELD-deviceip,
               1 AS events
          FROM siem.elog_sp$SPID
          WHERE _devlogtype = 3015 AND virus IS NOT NULL AND subtype != 'admin'
)
GROUP BY _adomoid, timescale, dvid, fgtserial, emsserial,
         virus, file, action, hostname, fctver, subtype;

CREATE MATERIALIZED VIEW IF NOT EXISTS siem.fv_fct_E_endpoint_malware_hour_mv_sp$SPID
TO siem.fv_fct_E_endpoint_malware_hour_sp$SPID
AS SELECT _adomoid, dvid,
       fv_timescale_func(timescale, 3600, 0) AS timescale,
       fgtserial, emsserial,
       virus,
       file,
       action,
       hostname,
       sumState(events) AS events_state
FROM (
   SELECT _adomoid, dvid,
       timescale,
       fgtserial, emsserial,
       virus,
       file,
       action,
       hostname,
       fctver, subtype,
       sumMerge(events_state) AS events
    FROM siem.fv_fct_E_endpoint_malware_5min_sp$SPID
    GROUP BY _adomoid, timescale, dvid, fgtserial, emsserial,
             virus, file, action, hostname, fctver, subtype
)
GROUP BY _adomoid, timescale, dvid, fgtserial, emsserial,
         virus, file, action, hostname, fctver, subtype;

CREATE MATERIALIZED VIEW IF NOT EXISTS siem.fv_fct_E_endpoint_malware_hour_mv_sp$SPID
TO siem.fv_fct_E_endpoint_malware_hour_sp$SPID
AS SELECT _adomoid, dvid,
       fv_timescale_func(timescale, 3600, 0) AS timescale,
       fgtserial, emsserial,
       virus,
       file,
       action,
       hostname,
       maxState(srcip) as srcip_state,
       sumState(events) AS events_state
FROM (
   SELECT _adomoid, dvid,
       timescale,
       fgtserial, emsserial,
       virus,
       file,
       action,
       hostname,
       fctver, subtype,
       maxMerge(srcip_state) as srcip,
       sumMerge(events_state) AS events
    FROM siem.fv_fct_E_endpoint_malware_5min_sp$SPID
    GROUP BY _adomoid, timescale, dvid, fgtserial, emsserial,
             virus, file, action, hostname, fctver, subtype
)
GROUP BY _adomoid, timescale, dvid, fgtserial, emsserial,
         virus, file, action, hostname, fctver, subtype;

CREATE MATERIALIZED VIEW IF NOT EXISTS siem.fv_fct_E_endpoint_malware_day_mv_sp$SPID
TO siem.fv_fct_E_endpoint_malware_day_sp$SPID
AS SELECT _adomoid, dvid,
       fv_timescale_func(timescale, 28800, 0) AS timescale,
       fgtserial, emsserial,
       virus,
       file,
       action,
       hostname,
       fctver, subtype,
       maxState(srcip) as srcip_state,
       sumState(events) AS events_state
FROM (
   SELECT _adomoid, dvid,
       timescale,
       fgtserial, emsserial,
       virus,
       file,
       action,
       hostname,
       fctver, subtype,
       maxMerge(srcip_state) as srcip,
       sumMerge(events_state) AS events
    FROM siem.fv_fct_E_endpoint_malware_hour_sp$SPID
    GROUP BY _adomoid, timescale, dvid, fgtserial, emsserial,
             virus, file, action, hostname, fctver, subtype
)
GROUP BY _adomoid, timescale, dvid, fgtserial, emsserial,
         virus, file, action, hostname, fctver, subtype;

ALTER TABLE siem.fv_fct_E_endpoint_malware_day_mv_sp$SPID MODIFY COMMENT '$VERSION';
