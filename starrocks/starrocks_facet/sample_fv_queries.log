-- -- -- __root_facet_result_nopart
-- #1 fv query chart
select * from (select fv_timescale_func(timescale, 14400, 0) as time, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, (sum(sessions)-sum(session_block)) as session_pass, sum(thwgt_cri) as score_critical, sum(thwgt_hig) as score_high, sum(thwgt_med) as score_medium, sum(thwgt_low) as score_low from (select * from (select t1.*, (case when (d_flags & 1) = 1 then 'Not.Scanned' when t2.app_cat is null then 'Unknown' else t2.app_cat end) as appcat, (case when t2.risk is null then 0 else cast(t2.risk as int) end) as d_risk from ((SELECT devid, vd, app_group, timescale, d_flags, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, sum(sessions) as sessions, sum(thwgt_cri) as thwgt_cri, sum(thwgt_hig) as thwgt_hig, sum(thwgt_med) as thwgt_med, sum(thwgt_low) as thwgt_low FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, bigint2 AS `policyid`, string18 AS `policytype`, int1 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint3 AS `threatweight`, bigint4 AS `threat_block`, bigint5 AS `thwgt_cri`, bigint6 AS `thwgt_hig`, bigint7 AS `thwgt_med`, bigint8 AS `thwgt_low`, bigint9 AS `bandwidth`, bigint10 AS `traffic_in`, bigint11 AS `traffic_out`, bigint12 AS `session_block`, bigint13 AS `sessions`, bigint14 AS `incident_block`, bigint15 AS `incidents`, bigint16 AS `row_rank` FROM __root_facet_result_nopart WHERE hash_id=-1963472838795349598) ___f_aggh4_1963472838795363998___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY devid, vd, app_group, timescale, d_flags) union all (SELECT devid, vd, app_group, timescale, d_flags, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, sum(sessions) as sessions, sum(thwgt_cri) as thwgt_cri, sum(thwgt_hig) as thwgt_hig, sum(thwgt_med) as thwgt_med, sum(thwgt_low) as thwgt_low FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, int1 AS `policyid`, string18 AS `policytype`, int2 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint2 AS `threatweight`, bigint3 AS `threat_block`, bigint4 AS `thwgt_cri`, bigint5 AS `thwgt_hig`, bigint6 AS `thwgt_med`, bigint7 AS `thwgt_low`, int3 AS `bandwidth`, int4 AS `traffic_in`, int5 AS `traffic_out`, int6 AS `session_block`, int7 AS `sessions`, bigint8 AS `incident_block`, bigint9 AS `incidents`, bigint10 AS `row_rank` FROM __root_facet_result_nopart WHERE hash_id=-4904897025178885934) ___f_aggh4_4904897025178900334___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY devid, vd, app_group, timescale, d_flags)) t1 left join app_mdata t2 on t1.app_group=t2.name) t where (TRUE)) t group by time order by time limit 1000000) t;

-- #2 fv query list
select * from (select f_user, srcip, srcuuid, group_concat(distinct srcintf SEPARATOR ',') as srcintf, group_concat(distinct concat(dev_src , ',' , coalesce(devtype, ' ')) SEPARATOR '|') as dev_src_agg, group_concat(distinct concat(srcmac , ',' , devtype) SEPARATOR '|') as mac_devtype_agg, sum(threatweight) as threatweight, sum(threat_block) as threat_block, (sum(threatweight)-sum(threat_block)) as threat_pass, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, sum(sessions) as sessions, (sum(sessions)-sum(session_block)) as session_pass, max(avatar) as avatar, max(epeuid) as epeuid, group_concat(distinct fortigate SEPARATOR ',') as fortigate, group_concat(distinct devvds SEPARATOR ',') as devvds from (select f_user, srcip, srcuuid, group_concat(distinct srcintf SEPARATOR ',') as srcintf, dev_src, max(devtype) as devtype, max(srcmac) as srcmac, sum(threatweight) as threatweight, sum(threat_block) as threat_block, (sum(threatweight)-sum(threat_block)) as threat_pass, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(incident_block) as session_block, (sum(incidents)-sum(incident_block)) as session_pass, sum(incidents) as sessions, max(avatar) as avatar, max(epeuid) as epeuid, group_concat(distinct devid SEPARATOR ',') as fortigate, group_concat(distinct devvd_str(devid, vd) SEPARATOR ',') as devvds from (select * from (select t1.*, (case when (d_flags & 1) = 1 then 'Not.Scanned' when t2.app_cat is null then 'Unknown' else t2.app_cat end) as appcat, (case when t2.risk is null then 0 else cast(t2.risk as int) end) as d_risk from ((SELECT f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group, sum(threatweight) as threatweight, sum(threat_block) as threat_block, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(incident_block) as incident_block, sum(incidents) as incidents, max(avatar) as avatar, max(epeuid) as epeuid FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, bigint2 AS `policyid`, string18 AS `policytype`, int1 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint3 AS `threatweight`, bigint4 AS `threat_block`, bigint5 AS `thwgt_cri`, bigint6 AS `thwgt_hig`, bigint7 AS `thwgt_med`, bigint8 AS `thwgt_low`, bigint9 AS `bandwidth`, bigint10 AS `traffic_in`, bigint11 AS `traffic_out`, bigint12 AS `session_block`, bigint13 AS `sessions`, bigint14 AS `incident_block`, bigint15 AS `incidents`, bigint16 AS `row_rank` FROM __root_facet_result_nopart WHERE hash_id=-1963472838795349598) ___f_aggh4_1963472838795363998___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group) union all (SELECT f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group, sum(threatweight) as threatweight, sum(threat_block) as threat_block, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(incident_block) as incident_block, sum(incidents) as incidents, max(avatar) as avatar, max(epeuid) as epeuid FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, int1 AS `policyid`, string18 AS `policytype`, int2 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint2 AS `threatweight`, bigint3 AS `threat_block`, bigint4 AS `thwgt_cri`, bigint5 AS `thwgt_hig`, bigint6 AS `thwgt_med`, bigint7 AS `thwgt_low`, int3 AS `bandwidth`, int4 AS `traffic_in`, int5 AS `traffic_out`, int6 AS `session_block`, int7 AS `sessions`, bigint8 AS `incident_block`, bigint9 AS `incidents`, bigint10 AS `row_rank` FROM __root_facet_result_nopart WHERE hash_id=-4904897025178885934) ___f_aggh4_4904897025178900334___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group)) t1 left join app_mdata t2 on t1.app_group=t2.name) t where (TRUE)) t group by f_user, srcip, srcuuid, dev_src having sum(bandwidth)>0 or sum(incidents)>0) t1 group by f_user, srcip, srcuuid order by `sessions` desc limit 100 ) t;


-- -- -- __root_facet_result_parted
-- #3 fv query chart
select * from (select fv_timescale_func(timescale, 14400, 0) as time, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, (sum(sessions)-sum(session_block)) as session_pass, sum(thwgt_cri) as score_critical, sum(thwgt_hig) as score_high, sum(thwgt_med) as score_medium, sum(thwgt_low) as score_low from (select * from (select t1.*, (case when (d_flags & 1) = 1 then 'Not.Scanned' when t2.app_cat is null then 'Unknown' else t2.app_cat end) as appcat, (case when t2.risk is null then 0 else cast(t2.risk as int) end) as d_risk from ((SELECT devid, vd, app_group, timescale, d_flags, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, sum(sessions) as sessions, sum(thwgt_cri) as thwgt_cri, sum(thwgt_hig) as thwgt_hig, sum(thwgt_med) as thwgt_med, sum(thwgt_low) as thwgt_low FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, bigint2 AS `policyid`, string18 AS `policytype`, int1 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint3 AS `threatweight`, bigint4 AS `threat_block`, bigint5 AS `thwgt_cri`, bigint6 AS `thwgt_hig`, bigint7 AS `thwgt_med`, bigint8 AS `thwgt_low`, bigint9 AS `bandwidth`, bigint10 AS `traffic_in`, bigint11 AS `traffic_out`, bigint12 AS `session_block`, bigint13 AS `sessions`, bigint14 AS `incident_block`, bigint15 AS `incidents`, bigint16 AS `row_rank` FROM __root_facet_result_parted WHERE hash_id=-1963472838795349598) ___f_aggh4_1963472838795363998___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY devid, vd, app_group, timescale, d_flags) union all (SELECT devid, vd, app_group, timescale, d_flags, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, sum(sessions) as sessions, sum(thwgt_cri) as thwgt_cri, sum(thwgt_hig) as thwgt_hig, sum(thwgt_med) as thwgt_med, sum(thwgt_low) as thwgt_low FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, int1 AS `policyid`, string18 AS `policytype`, int2 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint2 AS `threatweight`, bigint3 AS `threat_block`, bigint4 AS `thwgt_cri`, bigint5 AS `thwgt_hig`, bigint6 AS `thwgt_med`, bigint7 AS `thwgt_low`, int3 AS `bandwidth`, int4 AS `traffic_in`, int5 AS `traffic_out`, int6 AS `session_block`, int7 AS `sessions`, bigint8 AS `incident_block`, bigint9 AS `incidents`, bigint10 AS `row_rank` FROM __root_facet_result_parted WHERE hash_id=-4904897025178885934) ___f_aggh4_4904897025178900334___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY devid, vd, app_group, timescale, d_flags)) t1 left join app_mdata t2 on t1.app_group=t2.name) t where (TRUE)) t group by time order by time limit 1000000) t;

-- #4 fv query list
select * from (select f_user, srcip, srcuuid, group_concat(distinct srcintf SEPARATOR ',') as srcintf, group_concat(distinct concat(dev_src , ',' , coalesce(devtype, ' ')) SEPARATOR '|') as dev_src_agg, group_concat(distinct concat(srcmac , ',' , devtype) SEPARATOR '|') as mac_devtype_agg, sum(threatweight) as threatweight, sum(threat_block) as threat_block, (sum(threatweight)-sum(threat_block)) as threat_pass, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, sum(sessions) as sessions, (sum(sessions)-sum(session_block)) as session_pass, max(avatar) as avatar, max(epeuid) as epeuid, group_concat(distinct fortigate SEPARATOR ',') as fortigate, group_concat(distinct devvds SEPARATOR ',') as devvds from (select f_user, srcip, srcuuid, group_concat(distinct srcintf SEPARATOR ',') as srcintf, dev_src, max(devtype) as devtype, max(srcmac) as srcmac, sum(threatweight) as threatweight, sum(threat_block) as threat_block, (sum(threatweight)-sum(threat_block)) as threat_pass, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(incident_block) as session_block, (sum(incidents)-sum(incident_block)) as session_pass, sum(incidents) as sessions, max(avatar) as avatar, max(epeuid) as epeuid, group_concat(distinct devid SEPARATOR ',') as fortigate, group_concat(distinct devvd_str(devid, vd) SEPARATOR ',') as devvds from (select * from (select t1.*, (case when (d_flags & 1) = 1 then 'Not.Scanned' when t2.app_cat is null then 'Unknown' else t2.app_cat end) as appcat, (case when t2.risk is null then 0 else cast(t2.risk as int) end) as d_risk from ((SELECT f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group, sum(threatweight) as threatweight, sum(threat_block) as threat_block, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(incident_block) as incident_block, sum(incidents) as incidents, max(avatar) as avatar, max(epeuid) as epeuid FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, bigint2 AS `policyid`, string18 AS `policytype`, int1 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint3 AS `threatweight`, bigint4 AS `threat_block`, bigint5 AS `thwgt_cri`, bigint6 AS `thwgt_hig`, bigint7 AS `thwgt_med`, bigint8 AS `thwgt_low`, bigint9 AS `bandwidth`, bigint10 AS `traffic_in`, bigint11 AS `traffic_out`, bigint12 AS `session_block`, bigint13 AS `sessions`, bigint14 AS `incident_block`, bigint15 AS `incidents`, bigint16 AS `row_rank` FROM __root_facet_result_parted WHERE hash_id=-1963472838795349598) ___f_aggh4_1963472838795363998___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group) union all (SELECT f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group, sum(threatweight) as threatweight, sum(threat_block) as threat_block, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(incident_block) as incident_block, sum(incidents) as incidents, max(avatar) as avatar, max(epeuid) as epeuid FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, int1 AS `policyid`, string18 AS `policytype`, int2 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint2 AS `threatweight`, bigint3 AS `threat_block`, bigint4 AS `thwgt_cri`, bigint5 AS `thwgt_hig`, bigint6 AS `thwgt_med`, bigint7 AS `thwgt_low`, int3 AS `bandwidth`, int4 AS `traffic_in`, int5 AS `traffic_out`, int6 AS `session_block`, int7 AS `sessions`, bigint8 AS `incident_block`, bigint9 AS `incidents`, bigint10 AS `row_rank` FROM __root_facet_result_parted WHERE hash_id=-4904897025178885934) ___f_aggh4_4904897025178900334___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group)) t1 left join app_mdata t2 on t1.app_group=t2.name) t where (TRUE)) t group by f_user, srcip, srcuuid, dev_src having sum(bandwidth)>0 or sum(incidents)>0) t1 group by f_user, srcip, srcuuid order by `sessions` desc limit 100 ) t;


-- -- -- __root_facet_result_rmrowno
-- #5 fv query chart
select * from (select fv_timescale_func(timescale, 14400, 0) as time, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, (sum(sessions)-sum(session_block)) as session_pass, sum(thwgt_cri) as score_critical, sum(thwgt_hig) as score_high, sum(thwgt_med) as score_medium, sum(thwgt_low) as score_low from (select * from (select t1.*, (case when (d_flags & 1) = 1 then 'Not.Scanned' when t2.app_cat is null then 'Unknown' else t2.app_cat end) as appcat, (case when t2.risk is null then 0 else cast(t2.risk as int) end) as d_risk from ((SELECT devid, vd, app_group, timescale, d_flags, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, sum(sessions) as sessions, sum(thwgt_cri) as thwgt_cri, sum(thwgt_hig) as thwgt_hig, sum(thwgt_med) as thwgt_med, sum(thwgt_low) as thwgt_low FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, bigint2 AS `policyid`, string18 AS `policytype`, int1 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint3 AS `threatweight`, bigint4 AS `threat_block`, bigint5 AS `thwgt_cri`, bigint6 AS `thwgt_hig`, bigint7 AS `thwgt_med`, bigint8 AS `thwgt_low`, bigint9 AS `bandwidth`, bigint10 AS `traffic_in`, bigint11 AS `traffic_out`, bigint12 AS `session_block`, bigint13 AS `sessions`, bigint14 AS `incident_block`, bigint15 AS `incidents`, bigint16 AS `row_rank` FROM __root_facet_result_rmrowno WHERE hash_id=-1963472838795349598) ___f_aggh4_1963472838795363998___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY devid, vd, app_group, timescale, d_flags) union all (SELECT devid, vd, app_group, timescale, d_flags, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, sum(sessions) as sessions, sum(thwgt_cri) as thwgt_cri, sum(thwgt_hig) as thwgt_hig, sum(thwgt_med) as thwgt_med, sum(thwgt_low) as thwgt_low FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, int1 AS `policyid`, string18 AS `policytype`, int2 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint2 AS `threatweight`, bigint3 AS `threat_block`, bigint4 AS `thwgt_cri`, bigint5 AS `thwgt_hig`, bigint6 AS `thwgt_med`, bigint7 AS `thwgt_low`, int3 AS `bandwidth`, int4 AS `traffic_in`, int5 AS `traffic_out`, int6 AS `session_block`, int7 AS `sessions`, bigint8 AS `incident_block`, bigint9 AS `incidents`, bigint10 AS `row_rank` FROM __root_facet_result_rmrowno WHERE hash_id=-4904897025178885934) ___f_aggh4_4904897025178900334___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY devid, vd, app_group, timescale, d_flags)) t1 left join app_mdata t2 on t1.app_group=t2.name) t where (TRUE)) t group by time order by time limit 1000000) t;

-- #6 fv query list
select * from (select f_user, srcip, srcuuid, group_concat(distinct srcintf SEPARATOR ',') as srcintf, group_concat(distinct concat(dev_src , ',' , coalesce(devtype, ' ')) SEPARATOR '|') as dev_src_agg, group_concat(distinct concat(srcmac , ',' , devtype) SEPARATOR '|') as mac_devtype_agg, sum(threatweight) as threatweight, sum(threat_block) as threat_block, (sum(threatweight)-sum(threat_block)) as threat_pass, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(session_block) as session_block, sum(sessions) as sessions, (sum(sessions)-sum(session_block)) as session_pass, max(avatar) as avatar, max(epeuid) as epeuid, group_concat(distinct fortigate SEPARATOR ',') as fortigate, group_concat(distinct devvds SEPARATOR ',') as devvds from (select f_user, srcip, srcuuid, group_concat(distinct srcintf SEPARATOR ',') as srcintf, dev_src, max(devtype) as devtype, max(srcmac) as srcmac, sum(threatweight) as threatweight, sum(threat_block) as threat_block, (sum(threatweight)-sum(threat_block)) as threat_pass, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(incident_block) as session_block, (sum(incidents)-sum(incident_block)) as session_pass, sum(incidents) as sessions, max(avatar) as avatar, max(epeuid) as epeuid, group_concat(distinct devid SEPARATOR ',') as fortigate, group_concat(distinct devvd_str(devid, vd) SEPARATOR ',') as devvds from (select * from (select t1.*, (case when (d_flags & 1) = 1 then 'Not.Scanned' when t2.app_cat is null then 'Unknown' else t2.app_cat end) as appcat, (case when t2.risk is null then 0 else cast(t2.risk as int) end) as d_risk from ((SELECT f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group, sum(threatweight) as threatweight, sum(threat_block) as threat_block, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(incident_block) as incident_block, sum(incidents) as incidents, max(avatar) as avatar, max(epeuid) as epeuid FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, bigint2 AS `policyid`, string18 AS `policytype`, int1 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint3 AS `threatweight`, bigint4 AS `threat_block`, bigint5 AS `thwgt_cri`, bigint6 AS `thwgt_hig`, bigint7 AS `thwgt_med`, bigint8 AS `thwgt_low`, bigint9 AS `bandwidth`, bigint10 AS `traffic_in`, bigint11 AS `traffic_out`, bigint12 AS `session_block`, bigint13 AS `sessions`, bigint14 AS `incident_block`, bigint15 AS `incidents`, bigint16 AS `row_rank` FROM __root_facet_result_rmrowno WHERE hash_id=-1963472838795349598) ___f_aggh4_1963472838795363998___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group) union all (SELECT f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group, sum(threatweight) as threatweight, sum(threat_block) as threat_block, sum(bandwidth) as bandwidth, sum(traffic_in) as traffic_in, sum(traffic_out) as traffic_out, sum(incident_block) as incident_block, sum(incidents) as incidents, max(avatar) as avatar, max(epeuid) as epeuid FROM ((select `adomid`,`devid`,`vd`,`srcintfrole`,`dstintfrole`,`timescale`,`epid`,`f_user`,`srcip`,`srcintf`,`srcuuid`,`srcmac`,`dev_src`,`dstip`,`dstintf`,`dstuuid`,`dstowner`,`dstmac`,`dstcountry`,`app_group`,`policymode`,`policyid`,`policytype`,`d_flags`,`catdesc`,`domain`,`devtype`,`avatar`,`epeuid`,`browsetime`,`accessproxy`,`crlevel`,`threatweight`,`threat_block`,`thwgt_cri`,`thwgt_hig`,`thwgt_med`,`thwgt_low`,`bandwidth`,`traffic_in`,`traffic_out`,`session_block`,`sessions`,`incident_block`,`incidents`,`row_rank` from ( SELECT start_time AS __start_time, adomid AS `adomid`, string0 AS `devid`, string1 AS `vd`, string2 AS `srcintfrole`, string3 AS `dstintfrole`, bigint1 AS `timescale`, int0 AS `epid`, string4 AS `f_user`, string5 AS `srcip`, string6 AS `srcintf`, string7 AS `srcuuid`, string8 AS `srcmac`, string9 AS `dev_src`, string10 AS `dstip`, string11 AS `dstintf`, string12 AS `dstuuid`, string13 AS `dstowner`, string14 AS `dstmac`, string15 AS `dstcountry`, string16 AS `app_group`, string17 AS `policymode`, int1 AS `policyid`, string18 AS `policytype`, int2 AS `d_flags`, string19 AS `catdesc`, string20 AS `domain`, string21 AS `devtype`, string22 AS `avatar`, string23 AS `epeuid`, string24 AS `browsetime`, string25 AS `accessproxy`, string26 AS `crlevel`, bigint2 AS `threatweight`, bigint3 AS `threat_block`, bigint4 AS `thwgt_cri`, bigint5 AS `thwgt_hig`, bigint6 AS `thwgt_med`, bigint7 AS `thwgt_low`, int3 AS `bandwidth`, int4 AS `traffic_in`, int5 AS `traffic_out`, int6 AS `session_block`, int7 AS `sessions`, bigint8 AS `incident_block`, bigint9 AS `incidents`, bigint10 AS `row_rank` FROM __root_facet_result_rmrowno WHERE hash_id=-4904897025178885934) ___f_aggh4_4904897025178900334___  where adomid=3 and ( (__start_time>='2025-02-20 08:00:00' and __start_time<='2025-02-27 15:59:59') ))) t WHERE (TRUE) AND (1=1) GROUP BY f_user, srcip, srcuuid, srcintf, dev_src, srcmac, devtype, devid, vd, d_flags, app_group)) t1 left join app_mdata t2 on t1.app_group=t2.name) t where (TRUE)) t group by f_user, srcip, srcuuid, dev_src having sum(bandwidth)>0 or sum(incidents)>0) t1 group by f_user, srcip, srcuuid order by `sessions` desc limit 100 ) t;
