
-- convert to starrocks

-- 8.5s (new partitioned in fazbd jobs)
insert into __root_facet_result(`hash_id`,`adomid`,`start_time`,`end_time`,row_no,slot, bigint0, string0, string1, string2, string3, bigint1, int0, string4, string5, string6, string7, string8, string9, string10, string11, string12, string13, string14, string15, string16, string17, string18, string19, string20, bigint2, int1, string21, string22, string23, bigint3, string24, string25, string26, string27, string28, string29, string30, string31, string32, string33, string34, int2, bigint4, bigint5, double0, double1, double2, double3, bigint6, bigint7, bigint8, bigint9, bigint10)select `hash_id`,`adomid` as __adomid,`__start_time`,`__end_time`, (UNIX_TIMESTAMP()%10000000)*100000000000+__adom_row_no*100000+adomid as row_no,cast(__adom_row_no as int) as `slot`, `adomid`, `devid`, `vd`, `srcintfrole`, `dstintfrole`, `timescale`, `epid`, `f_user`, `f_group`, `srcip`, `srcintf`, `srcuuid`, `srcinetsvc`, `srcmac`, `dev_src`, `dstip`, `dstintf`, `dstuuid`, `dstowner`, `dstmac`, `devtype`, `dstcountry`, `app_group`, `rulename`, `vwlid`, `flags`, `domain`, `catdesc`, `policymode`, `policyid`, `policytype`, `poluuid`, `policyname`, `accessproxy`, `saasname`, `fctuid`, `service`, `avatar`, `epeuid`, `browsetime`, `logtime`, `threatlvl`, `threatweight`, `threat_block`, `thwgt_cri`, `thwgt_hig`, `thwgt_med`, `thwgt_low`, `bandwidth`, `traffic_in`, `traffic_out`, `session_block`, `sessions` from (select -8018786850174537879 as `hash_id`, '2025-02-28 18:40:00' as __start_time, '2025-02-28 18:49:59' as __end_time, row_number() over( partition by adomid order by `sessions` desc) as __adom_row_no , `adomid`, `devid`, `vd`, `srcintfrole`, `dstintfrole`, `timescale`, `epid`, `f_user`, `f_group`, `srcip`, `srcintf`, `srcuuid`, `srcinetsvc`, `srcmac`, `dev_src`, `dstip`, `dstintf`, `dstuuid`, `dstowner`, `dstmac`, `devtype`, `dstcountry`, `app_group`, `rulename`, `vwlid`, `flags`, `domain`, `catdesc`, `policymode`, `policyid`, `policytype`, `poluuid`, `policyname`, `accessproxy`, `saasname`, `fctuid`, `service`, `avatar`, `epeuid`, `browsetime`, `logtime`, `threatlvl`, `threatweight`, `threat_block`, `thwgt_cri`, `thwgt_hig`, `thwgt_med`, `thwgt_low`, `bandwidth`, `traffic_in`, `traffic_out`, `session_block`, `sessions` from(/*tag:fv_base_t_src_dst*/SELECT adomid, devid, vd, srcintfrole, dstintfrole, fv_timescale_func(unix_timestamp(itime), 600, 0) AS timescale, epid, coalesce(nullifna(`user`), nullifna(`unauthuser`)) AS f_user, `group` AS f_group, srcip, srcintf, srcuuid, srcinetsvc, max(srcmac) AS srcmac, max(coalesce(srcname, srcmac)) AS dev_src, dstip, dstintf, dstuuid, dstowner, max(dstmac) AS dstmac, max(get_devtype(srcswversion, osname, devtype)) AS devtype, max(dstcountry) AS dstcountry, app_group_name(app) AS app_group, rulename, vwlid, ((CASE WHEN (logflag&64>0) THEN 2 ELSE 0 END) | (CASE WHEN appcat='unscanned' THEN 1 ELSE 0 END)) AS flags, (CASE WHEN (logflag&64>0) THEN hostname ELSE root_domain(hostname) END) AS domain, catdesc, policymode, policyid, policytype, poluuid, policyname, accessproxy, saasname, fctuid, service, max((CASE WHEN fctuid IS NOT NULL AND unauthuser IS NOT NULL THEN concat(fctuid, ',', unauthuser) ELSE NULL END)) AS avatar, max((CASE WHEN epid>1023 AND euid IS NOT NULL THEN CONCAT(cast(epid as string), ',',  cast(euid as string)) ELSE NULL END)) AS epeuid, ebtr_agg_flat(ebtime) AS browsetime, max(dtime) AS logtime, max(threatlvl) AS threatlvl, sum(threatwgt) AS threatweight, sum(CASE WHEN (logflag&2>0) THEN threatwgt ELSE 0 END) AS threat_block, sum(thwgt_cri) AS thwgt_cri, sum(thwgt_hig) AS thwgt_hig, sum(thwgt_med) AS thwgt_med, sum(thwgt_low) AS thwgt_low, sum(coalesce(sentdelta, sentbyte, 0)+coalesce(rcvddelta, rcvdbyte, 0)) AS bandwidth, sum(coalesce(rcvddelta, rcvdbyte, 0)) AS traffic_in, sum(coalesce(sentdelta, sentbyte, 0)) AS traffic_out, sum((CASE WHEN (logflag&2>0) THEN 1 ELSE 0 END)) AS session_block, sum(CASE WHEN (logflag&1>0) THEN 1 ELSE 0 END) AS sessions FROM ( SELECT adomid, devid, vd, srcintfrole, dstintfrole, itime, dtime, (case when cast(epid as int)<1024 then NULL else epid end) as epid, euid, `user`, `group`, srcip, srcintf, srcmac, srcname, dstip, dstintf, dstowner, dstmac, dstcountry, app, appcat, srcswversion, osname, devtype, hostname, catdesc, srcuuid, dstuuid, srcinetsvc, accessproxy, saasname, policymode, policyid, policytype, poluuid, policyname, unauthuser, fctuid, service, ebtime, logflag, sentdelta, sentbyte, rcvddelta, rcvdbyte, coalesce(vwlname,vwlservice) as rulename, vwlid, threatlevel_max(threatlvls) AS threatlvl, threatweight_sum(threatwgts, threatcnts) AS threatwgt, threatweight_level_sum(4,threatlvls,threatcnts,threatwgts) AS thwgt_cri, threatweight_level_sum(3,threatlvls,threatcnts,threatwgts) AS thwgt_hig, threatweight_level_sum(2,threatlvls,threatcnts,threatwgts) AS thwgt_med, threatweight_level_sum(1,threatlvls,threatcnts,threatwgts) AS thwgt_low FROM (select * from __root_fgt_traffic_view where itime>='2025-02-28 18:40:00' and itime<='2025-02-28 18:49:59'  )  t1 WHERE (1=1) AND (logflag&(1|32)>0) ) t1 GROUP BY adomid, devid, vd, srcintfrole, dstintfrole, timescale, epid, f_user, f_group, srcip, srcintf, dstip, dstintf, dstowner, app_group, rulename, vwlid, flags, domain, catdesc, policymode, policyid, policytype, poluuid, policyname, accessproxy, saasname, fctuid, service, srcuuid, dstuuid, srcinetsvc ) __base_sql  ) __partition_sql where __adom_row_no<=400000;

-- 14.84 sec (partitioned)
-- 14.43
insert into __root_facet_result_parted(`hash_id`,`adomid`,`start_time`,`end_time`,row_no,slot, bigint0, string0, string1, string2, string3, bigint1, int0, string4, string5, string6, string7, string8, string9, string10, string11, string12, string13, string14, string15, string16, string17, string18, string19, string20, bigint2, int1, string21, string22, string23, bigint3, string24, string25, string26, string27, string28, string29, string30, string31, string32, string33, string34, int2, bigint4, bigint5, double0, double1, double2, double3, bigint6, bigint7, bigint8, bigint9, bigint10)select `hash_id`,`adomid` as __adomid,`__start_time`,`__end_time`, (UNIX_TIMESTAMP()%10000000)*100000000000+__adom_row_no*100000+adomid as row_no,cast(__adom_row_no as int) as `slot`, `adomid`, `devid`, `vd`, `srcintfrole`, `dstintfrole`, `timescale`, `epid`, `f_user`, `f_group`, `srcip`, `srcintf`, `srcuuid`, `srcinetsvc`, `srcmac`, `dev_src`, `dstip`, `dstintf`, `dstuuid`, `dstowner`, `dstmac`, `devtype`, `dstcountry`, `app_group`, `rulename`, `vwlid`, `flags`, `domain`, `catdesc`, `policymode`, `policyid`, `policytype`, `poluuid`, `policyname`, `accessproxy`, `saasname`, `fctuid`, `service`, `avatar`, `epeuid`, `browsetime`, `logtime`, `threatlvl`, `threatweight`, `threat_block`, `thwgt_cri`, `thwgt_hig`, `thwgt_med`, `thwgt_low`, `bandwidth`, `traffic_in`, `traffic_out`, `session_block`, `sessions` from (select -8018786850174537879 as `hash_id`, '2025-02-28 18:40:00' as __start_time, '2025-02-28 18:49:59' as __end_time, row_number() over( partition by adomid order by `sessions` desc) as __adom_row_no , `adomid`, `devid`, `vd`, `srcintfrole`, `dstintfrole`, `timescale`, `epid`, `f_user`, `f_group`, `srcip`, `srcintf`, `srcuuid`, `srcinetsvc`, `srcmac`, `dev_src`, `dstip`, `dstintf`, `dstuuid`, `dstowner`, `dstmac`, `devtype`, `dstcountry`, `app_group`, `rulename`, `vwlid`, `flags`, `domain`, `catdesc`, `policymode`, `policyid`, `policytype`, `poluuid`, `policyname`, `accessproxy`, `saasname`, `fctuid`, `service`, `avatar`, `epeuid`, `browsetime`, `logtime`, `threatlvl`, `threatweight`, `threat_block`, `thwgt_cri`, `thwgt_hig`, `thwgt_med`, `thwgt_low`, `bandwidth`, `traffic_in`, `traffic_out`, `session_block`, `sessions` from(/*tag:fv_base_t_src_dst*/SELECT adomid, devid, vd, srcintfrole, dstintfrole, fv_timescale_func(unix_timestamp(itime), 600, 0) AS timescale, epid, coalesce(nullifna(`user`), nullifna(`unauthuser`)) AS f_user, `group` AS f_group, srcip, srcintf, srcuuid, srcinetsvc, max(srcmac) AS srcmac, max(coalesce(srcname, srcmac)) AS dev_src, dstip, dstintf, dstuuid, dstowner, max(dstmac) AS dstmac, max(get_devtype(srcswversion, osname, devtype)) AS devtype, max(dstcountry) AS dstcountry, app_group_name(app) AS app_group, rulename, vwlid, ((CASE WHEN (logflag&64>0) THEN 2 ELSE 0 END) | (CASE WHEN appcat='unscanned' THEN 1 ELSE 0 END)) AS flags, (CASE WHEN (logflag&64>0) THEN hostname ELSE root_domain(hostname) END) AS domain, catdesc, policymode, policyid, policytype, poluuid, policyname, accessproxy, saasname, fctuid, service, max((CASE WHEN fctuid IS NOT NULL AND unauthuser IS NOT NULL THEN concat(fctuid, ',', unauthuser) ELSE NULL END)) AS avatar, max((CASE WHEN epid>1023 AND euid IS NOT NULL THEN CONCAT(cast(epid as string), ',',  cast(euid as string)) ELSE NULL END)) AS epeuid, ebtr_agg_flat(ebtime) AS browsetime, max(dtime) AS logtime, max(threatlvl) AS threatlvl, sum(threatwgt) AS threatweight, sum(CASE WHEN (logflag&2>0) THEN threatwgt ELSE 0 END) AS threat_block, sum(thwgt_cri) AS thwgt_cri, sum(thwgt_hig) AS thwgt_hig, sum(thwgt_med) AS thwgt_med, sum(thwgt_low) AS thwgt_low, sum(coalesce(sentdelta, sentbyte, 0)+coalesce(rcvddelta, rcvdbyte, 0)) AS bandwidth, sum(coalesce(rcvddelta, rcvdbyte, 0)) AS traffic_in, sum(coalesce(sentdelta, sentbyte, 0)) AS traffic_out, sum((CASE WHEN (logflag&2>0) THEN 1 ELSE 0 END)) AS session_block, sum(CASE WHEN (logflag&1>0) THEN 1 ELSE 0 END) AS sessions FROM ( SELECT adomid, devid, vd, srcintfrole, dstintfrole, itime, dtime, (case when cast(epid as int)<1024 then NULL else epid end) as epid, euid, `user`, `group`, srcip, srcintf, srcmac, srcname, dstip, dstintf, dstowner, dstmac, dstcountry, app, appcat, srcswversion, osname, devtype, hostname, catdesc, srcuuid, dstuuid, srcinetsvc, accessproxy, saasname, policymode, policyid, policytype, poluuid, policyname, unauthuser, fctuid, service, ebtime, logflag, sentdelta, sentbyte, rcvddelta, rcvdbyte, coalesce(vwlname,vwlservice) as rulename, vwlid, threatlevel_max(threatlvls) AS threatlvl, threatweight_sum(threatwgts, threatcnts) AS threatwgt, threatweight_level_sum(4,threatlvls,threatcnts,threatwgts) AS thwgt_cri, threatweight_level_sum(3,threatlvls,threatcnts,threatwgts) AS thwgt_hig, threatweight_level_sum(2,threatlvls,threatcnts,threatwgts) AS thwgt_med, threatweight_level_sum(1,threatlvls,threatcnts,threatwgts) AS thwgt_low FROM (select * from __root_fgt_traffic_view where itime>='2025-02-28 18:40:00' and itime<='2025-02-28 18:49:59'  )  t1 WHERE (1=1) AND (logflag&(1|32)>0) ) t1 GROUP BY adomid, devid, vd, srcintfrole, dstintfrole, timescale, epid, f_user, f_group, srcip, srcintf, dstip, dstintf, dstowner, app_group, rulename, vwlid, flags, domain, catdesc, policymode, policyid, policytype, poluuid, policyname, accessproxy, saasname, fctuid, service, srcuuid, dstuuid, srcinetsvc ) __base_sql  ) __partition_sql where __adom_row_no<=400000;

-- 15.98 s ( no partitions)
-- 14.35
insert into __root_facet_result_nopart(`hash_id`,`adomid`,`start_time`,`end_time`,row_no,slot, bigint0, string0, string1, string2, string3, bigint1, int0, string4, string5, string6, string7, string8, string9, string10, string11, string12, string13, string14, string15, string16, string17, string18, string19, string20, bigint2, int1, string21, string22, string23, bigint3, string24, string25, string26, string27, string28, string29, string30, string31, string32, string33, string34, int2, bigint4, bigint5, double0, double1, double2, double3, bigint6, bigint7, bigint8, bigint9, bigint10)select `hash_id`,`adomid` as __adomid,`__start_time`,`__end_time`, (UNIX_TIMESTAMP()%10000000)*100000000000+__adom_row_no*100000+adomid as row_no,cast(__adom_row_no as int) as `slot`, `adomid`, `devid`, `vd`, `srcintfrole`, `dstintfrole`, `timescale`, `epid`, `f_user`, `f_group`, `srcip`, `srcintf`, `srcuuid`, `srcinetsvc`, `srcmac`, `dev_src`, `dstip`, `dstintf`, `dstuuid`, `dstowner`, `dstmac`, `devtype`, `dstcountry`, `app_group`, `rulename`, `vwlid`, `flags`, `domain`, `catdesc`, `policymode`, `policyid`, `policytype`, `poluuid`, `policyname`, `accessproxy`, `saasname`, `fctuid`, `service`, `avatar`, `epeuid`, `browsetime`, `logtime`, `threatlvl`, `threatweight`, `threat_block`, `thwgt_cri`, `thwgt_hig`, `thwgt_med`, `thwgt_low`, `bandwidth`, `traffic_in`, `traffic_out`, `session_block`, `sessions` from (select -8018786850174537879 as `hash_id`, '2025-02-28 18:40:00' as __start_time, '2025-02-28 18:49:59' as __end_time, row_number() over( partition by adomid order by `sessions` desc) as __adom_row_no , `adomid`, `devid`, `vd`, `srcintfrole`, `dstintfrole`, `timescale`, `epid`, `f_user`, `f_group`, `srcip`, `srcintf`, `srcuuid`, `srcinetsvc`, `srcmac`, `dev_src`, `dstip`, `dstintf`, `dstuuid`, `dstowner`, `dstmac`, `devtype`, `dstcountry`, `app_group`, `rulename`, `vwlid`, `flags`, `domain`, `catdesc`, `policymode`, `policyid`, `policytype`, `poluuid`, `policyname`, `accessproxy`, `saasname`, `fctuid`, `service`, `avatar`, `epeuid`, `browsetime`, `logtime`, `threatlvl`, `threatweight`, `threat_block`, `thwgt_cri`, `thwgt_hig`, `thwgt_med`, `thwgt_low`, `bandwidth`, `traffic_in`, `traffic_out`, `session_block`, `sessions` from(/*tag:fv_base_t_src_dst*/SELECT adomid, devid, vd, srcintfrole, dstintfrole, fv_timescale_func(unix_timestamp(itime), 600, 0) AS timescale, epid, coalesce(nullifna(`user`), nullifna(`unauthuser`)) AS f_user, `group` AS f_group, srcip, srcintf, srcuuid, srcinetsvc, max(srcmac) AS srcmac, max(coalesce(srcname, srcmac)) AS dev_src, dstip, dstintf, dstuuid, dstowner, max(dstmac) AS dstmac, max(get_devtype(srcswversion, osname, devtype)) AS devtype, max(dstcountry) AS dstcountry, app_group_name(app) AS app_group, rulename, vwlid, ((CASE WHEN (logflag&64>0) THEN 2 ELSE 0 END) | (CASE WHEN appcat='unscanned' THEN 1 ELSE 0 END)) AS flags, (CASE WHEN (logflag&64>0) THEN hostname ELSE root_domain(hostname) END) AS domain, catdesc, policymode, policyid, policytype, poluuid, policyname, accessproxy, saasname, fctuid, service, max((CASE WHEN fctuid IS NOT NULL AND unauthuser IS NOT NULL THEN concat(fctuid, ',', unauthuser) ELSE NULL END)) AS avatar, max((CASE WHEN epid>1023 AND euid IS NOT NULL THEN CONCAT(cast(epid as string), ',',  cast(euid as string)) ELSE NULL END)) AS epeuid, ebtr_agg_flat(ebtime) AS browsetime, max(dtime) AS logtime, max(threatlvl) AS threatlvl, sum(threatwgt) AS threatweight, sum(CASE WHEN (logflag&2>0) THEN threatwgt ELSE 0 END) AS threat_block, sum(thwgt_cri) AS thwgt_cri, sum(thwgt_hig) AS thwgt_hig, sum(thwgt_med) AS thwgt_med, sum(thwgt_low) AS thwgt_low, sum(coalesce(sentdelta, sentbyte, 0)+coalesce(rcvddelta, rcvdbyte, 0)) AS bandwidth, sum(coalesce(rcvddelta, rcvdbyte, 0)) AS traffic_in, sum(coalesce(sentdelta, sentbyte, 0)) AS traffic_out, sum((CASE WHEN (logflag&2>0) THEN 1 ELSE 0 END)) AS session_block, sum(CASE WHEN (logflag&1>0) THEN 1 ELSE 0 END) AS sessions FROM ( SELECT adomid, devid, vd, srcintfrole, dstintfrole, itime, dtime, (case when cast(epid as int)<1024 then NULL else epid end) as epid, euid, `user`, `group`, srcip, srcintf, srcmac, srcname, dstip, dstintf, dstowner, dstmac, dstcountry, app, appcat, srcswversion, osname, devtype, hostname, catdesc, srcuuid, dstuuid, srcinetsvc, accessproxy, saasname, policymode, policyid, policytype, poluuid, policyname, unauthuser, fctuid, service, ebtime, logflag, sentdelta, sentbyte, rcvddelta, rcvdbyte, coalesce(vwlname,vwlservice) as rulename, vwlid, threatlevel_max(threatlvls) AS threatlvl, threatweight_sum(threatwgts, threatcnts) AS threatwgt, threatweight_level_sum(4,threatlvls,threatcnts,threatwgts) AS thwgt_cri, threatweight_level_sum(3,threatlvls,threatcnts,threatwgts) AS thwgt_hig, threatweight_level_sum(2,threatlvls,threatcnts,threatwgts) AS thwgt_med, threatweight_level_sum(1,threatlvls,threatcnts,threatwgts) AS thwgt_low FROM (select * from __root_fgt_traffic_view where itime>='2025-02-28 18:40:00' and itime<='2025-02-28 18:49:59'  )  t1 WHERE (1=1) AND (logflag&(1|32)>0) ) t1 GROUP BY adomid, devid, vd, srcintfrole, dstintfrole, timescale, epid, f_user, f_group, srcip, srcintf, dstip, dstintf, dstowner, app_group, rulename, vwlid, flags, domain, catdesc, policymode, policyid, policytype, poluuid, policyname, accessproxy, saasname, fctuid, service, srcuuid, dstuuid, srcinetsvc ) __base_sql  ) __partition_sql where __adom_row_no<=400000;

-- 14.08 sec (removed rowno)
-- 15.42 sec

insert into __root_facet_result_rmrowno(`hash_id`,`adomid`,`start_time`,`end_time`,row_no,slot, bigint0, string0, string1, string2, string3, bigint1, int0, string4, string5, string6, string7, string8, string9, string10, string11, string12, string13, string14, string15, string16, string17, string18, string19, string20, bigint2, int1, string21, string22, string23, bigint3, string24, string25, string26, string27, string28, string29, string30, string31, string32, string33, string34, int2, bigint4, bigint5, double0, double1, double2, double3, bigint6, bigint7, bigint8, bigint9, bigint10)select `hash_id`,`adomid` as __adomid,`__start_time`,`__end_time`, (UNIX_TIMESTAMP()%10000000)*100000000000+__adom_row_no*100000+adomid as row_no,cast(__adom_row_no as int) as `slot`, `adomid`, `devid`, `vd`, `srcintfrole`, `dstintfrole`, `timescale`, `epid`, `f_user`, `f_group`, `srcip`, `srcintf`, `srcuuid`, `srcinetsvc`, `srcmac`, `dev_src`, `dstip`, `dstintf`, `dstuuid`, `dstowner`, `dstmac`, `devtype`, `dstcountry`, `app_group`, `rulename`, `vwlid`, `flags`, `domain`, `catdesc`, `policymode`, `policyid`, `policytype`, `poluuid`, `policyname`, `accessproxy`, `saasname`, `fctuid`, `service`, `avatar`, `epeuid`, `browsetime`, `logtime`, `threatlvl`, `threatweight`, `threat_block`, `thwgt_cri`, `thwgt_hig`, `thwgt_med`, `thwgt_low`, `bandwidth`, `traffic_in`, `traffic_out`, `session_block`, `sessions` from (select -8018786850174537879 as `hash_id`, '2025-02-28 18:40:00' as __start_time, '2025-02-28 18:49:59' as __end_time, row_number() over( partition by adomid order by `sessions` desc) as __adom_row_no , `adomid`, `devid`, `vd`, `srcintfrole`, `dstintfrole`, `timescale`, `epid`, `f_user`, `f_group`, `srcip`, `srcintf`, `srcuuid`, `srcinetsvc`, `srcmac`, `dev_src`, `dstip`, `dstintf`, `dstuuid`, `dstowner`, `dstmac`, `devtype`, `dstcountry`, `app_group`, `rulename`, `vwlid`, `flags`, `domain`, `catdesc`, `policymode`, `policyid`, `policytype`, `poluuid`, `policyname`, `accessproxy`, `saasname`, `fctuid`, `service`, `avatar`, `epeuid`, `browsetime`, `logtime`, `threatlvl`, `threatweight`, `threat_block`, `thwgt_cri`, `thwgt_hig`, `thwgt_med`, `thwgt_low`, `bandwidth`, `traffic_in`, `traffic_out`, `session_block`, `sessions` from(/*tag:fv_base_t_src_dst*/SELECT adomid, devid, vd, srcintfrole, dstintfrole, fv_timescale_func(unix_timestamp(itime), 600, 0) AS timescale, epid, coalesce(nullifna(`user`), nullifna(`unauthuser`)) AS f_user, `group` AS f_group, srcip, srcintf, srcuuid, srcinetsvc, max(srcmac) AS srcmac, max(coalesce(srcname, srcmac)) AS dev_src, dstip, dstintf, dstuuid, dstowner, max(dstmac) AS dstmac, max(get_devtype(srcswversion, osname, devtype)) AS devtype, max(dstcountry) AS dstcountry, app_group_name(app) AS app_group, rulename, vwlid, ((CASE WHEN (logflag&64>0) THEN 2 ELSE 0 END) | (CASE WHEN appcat='unscanned' THEN 1 ELSE 0 END)) AS flags, (CASE WHEN (logflag&64>0) THEN hostname ELSE root_domain(hostname) END) AS domain, catdesc, policymode, policyid, policytype, poluuid, policyname, accessproxy, saasname, fctuid, service, max((CASE WHEN fctuid IS NOT NULL AND unauthuser IS NOT NULL THEN concat(fctuid, ',', unauthuser) ELSE NULL END)) AS avatar, max((CASE WHEN epid>1023 AND euid IS NOT NULL THEN CONCAT(cast(epid as string), ',',  cast(euid as string)) ELSE NULL END)) AS epeuid, ebtr_agg_flat(ebtime) AS browsetime, max(dtime) AS logtime, max(threatlvl) AS threatlvl, sum(threatwgt) AS threatweight, sum(CASE WHEN (logflag&2>0) THEN threatwgt ELSE 0 END) AS threat_block, sum(thwgt_cri) AS thwgt_cri, sum(thwgt_hig) AS thwgt_hig, sum(thwgt_med) AS thwgt_med, sum(thwgt_low) AS thwgt_low, sum(coalesce(sentdelta, sentbyte, 0)+coalesce(rcvddelta, rcvdbyte, 0)) AS bandwidth, sum(coalesce(rcvddelta, rcvdbyte, 0)) AS traffic_in, sum(coalesce(sentdelta, sentbyte, 0)) AS traffic_out, sum((CASE WHEN (logflag&2>0) THEN 1 ELSE 0 END)) AS session_block, sum(CASE WHEN (logflag&1>0) THEN 1 ELSE 0 END) AS sessions FROM ( SELECT adomid, devid, vd, srcintfrole, dstintfrole, itime, dtime, (case when cast(epid as int)<1024 then NULL else epid end) as epid, euid, `user`, `group`, srcip, srcintf, srcmac, srcname, dstip, dstintf, dstowner, dstmac, dstcountry, app, appcat, srcswversion, osname, devtype, hostname, catdesc, srcuuid, dstuuid, srcinetsvc, accessproxy, saasname, policymode, policyid, policytype, poluuid, policyname, unauthuser, fctuid, service, ebtime, logflag, sentdelta, sentbyte, rcvddelta, rcvdbyte, coalesce(vwlname,vwlservice) as rulename, vwlid, threatlevel_max(threatlvls) AS threatlvl, threatweight_sum(threatwgts, threatcnts) AS threatwgt, threatweight_level_sum(4,threatlvls,threatcnts,threatwgts) AS thwgt_cri, threatweight_level_sum(3,threatlvls,threatcnts,threatwgts) AS thwgt_hig, threatweight_level_sum(2,threatlvls,threatcnts,threatwgts) AS thwgt_med, threatweight_level_sum(1,threatlvls,threatcnts,threatwgts) AS thwgt_low FROM (select * from __root_fgt_traffic_view where itime>='2025-02-28 18:40:00' and itime<='2025-02-28 18:49:59'  )  t1 WHERE (1=1) AND (logflag&(1|32)>0) ) t1 GROUP BY adomid, devid, vd, srcintfrole, dstintfrole, timescale, epid, f_user, f_group, srcip, srcintf, dstip, dstintf, dstowner, app_group, rulename, vwlid, flags, domain, catdesc, policymode, policyid, policytype, poluuid, policyname, accessproxy, saasname, fctuid, service, srcuuid, dstuuid, srcinetsvc ) __base_sql  ) __partition_sql where __adom_row_no<=400000;
