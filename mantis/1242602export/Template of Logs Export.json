[ {
  "jobName" : "custom-job-c09c99aa-ce30-4d0d-8099-eb79d7ba2ccd",
  "jobSummary" : "Template of Logs Export",
  "taskTemplate" : "custom-template",
  "cronExp" : "0 0 2 ? * * *",
  "cronTimezone" : "US/Pacific",
  "enabled" : true,
  "allowConcurrent" : false,
  "jobTimeout" : 0,
  "retryOnFailure" : 0,
  "retryBackoff" : 0,
  "jobVars" : {
    "playbook_content" : "- name: Template of Logs Export\n  hosts: controllerIp\n  gather_facts: yes\n\n  vars:\n    # --- User Configuration ---\n    #\n    # IMPORTANT: Before running this playbook, you must replace all placeholder\n    # values marked with angle brackets and uppercase letters (e.g., <PLACEHOLDER>).\n    # Sample values are provided in the comments for guidance.\n    # Note: start_date and end_date default to yesterday's date automatically.\n    #\n\n    # 1. Export Parameters\n    # These parameters are passed directly to the 'fazbd-log-export init' command.\n    # The JSON configuration is passed as a positional argument (not with --config flag).\n    # Note: start_date and end_date are automatically calculated based on last_n_days.\n    #\n    # Sample: '{ \"adom\": \"root\", \"log_type\": \"hyperscale\", \"device_type\": \"fgt\", \"device_ids\": [\"FG100FTK20016262\",\"FG100FTK20016263\"], \"start_date\": \"2023-08-01\", \"end_date\": \"2023-08-01\", \"format\": \"csv\" }'\n    \n    # Number of days to export logs (default: 1 = yesterday only)\n    # Change this value to export logs from the last N days\n    # Example: 1 = yesterday only, 2 = last 2 days (day before yesterday to yesterday), 7 = last week\n    last_n_days: 1\n    \n    # Export configuration parameters (replace placeholders with actual values)\n    # Example:\n#    export_adom: \"root\"\n#    export_log_type: \"hyperscale\"\n#    export_device_type: \"fgt\"\n#    export_device_id: [\"FG180F1234000022\",\"FG100FTK20016263\"]\n\n    export_adom: \"<ADOM_NAME>\"\n    export_log_type: \"<LOG_TYPE>\"\n    export_device_type: \"<DEVICE_TYPE>\"\n    export_device_id: \"<YOUR_DEVICE_ID_LIST>\"\n\n    export_format: \"csv\"\n\n    # 2. Push (Remote Server) Parameters\n    # Details for the remote server where logs will be pushed.\n    # Example:\n#    push_host_port: \"10.105.101.4\"\n#    push_user: \"root\"\n#    push_password: \"xxxxxxxx\"\n#    push_directory: \"/data2/xl/export\"\n\n    push_host_port: \"<REMOTE_HOST_IP>\"\n    push_user: \"<REMOTE_USER>\"\n    push_password: \"<REMOTE_PASSWORD_OR_EMPTY_FOR_KEY>\"\n    push_directory: \"<REMOTE_PATH>\"\n\n    push_protocol: \"scp\"\n\n    # 3. Polling Settings\n    # How many times to check for status and how long to wait between checks.\n    status_check_retries: 120\n    status_check_delay: 60\n\n    # Start date: N days ago (calculated dynamically based on last_n_days)\n    start_date: \"{{ '%Y-%m-%d' | strftime(ansible_date_time.epoch | int - 86400 * last_n_days) }}\"\n    # End date: yesterday (always 1 day ago)\n    end_date: \"{{ '%Y-%m-%d' | strftime(ansible_date_time.epoch | int - 86400) }}\"\n\n    # 4. Success Indicators (from actual command output)\n    # Text to look for to confirm completion of each stage.\n    export_success_indicator: \"completed\"\n    # Push completion is detected by checking if the directory exists on remote host\n    # since fazbd-log-export status may not update correctly after push\n\n    # --- End of User Configuration ---\n\n  tasks:\n    - name: \"Pre-flight Check: Ensure all placeholder values have been replaced\"\n      ansible.builtin.fail:\n        msg: \"Configuration error. Found unreplaced placeholder values (e.g., <PLACEHOLDER>). Please replace all placeholders before running.\"\n      when: \"'<' in export_adom or '<' in export_log_type or '<' in push_host_port or '<' in push_user or '<' in push_directory\"\n\n    - name: \"Set current date for export directory naming\"\n      ansible.builtin.set_fact:\n        export_date: \"{{ ansible_date_time.date | replace('-', '') }}\"\n\n    - name: \"Display Configuration\"\n      ansible.builtin.debug:\n        msg: |\n          Export Configuration:\n            adom: {{ export_adom }}\n            log_type: {{ export_log_type }}\n            device_type: {{ export_device_type }}\n            device_id: {{ export_device_id }}\n            start_date: {{ start_date }}\n            end_date: {{ end_date }}\n            format: {{ export_format }}\n          Push Configuration:\n            protocol: {{ push_protocol }}\n            host_port: {{ push_host_port }}\n            user: {{ push_user }}\n            directory: {{ push_directory }}\n          Export Date: {{ export_date }}\n\n    - name: \"Pre-flight Check: Verify SSH access to remote host\"\n      ansible.builtin.shell:\n        cmd: \"sshpass -p '{{ push_password }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ push_user }}@{{ push_host_port }} 'echo \\\"SSH connection to {{ push_host_port }} successful\\\"'\"\n      register: ssh_check\n      changed_when: false\n      ignore_errors: true\n      when: push_password | length > 0\n\n    - name: \"Pre-flight Check: Verify SSH access to remote host (key-based)\"\n      ansible.builtin.shell:\n        cmd: \"ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null -o BatchMode=yes {{ push_user }}@{{ push_host_port }} 'echo \\\"SSH connection to {{ push_host_port }} successful\\\"'\"\n      register: ssh_check_key\n      changed_when: false\n      ignore_errors: true\n      when: push_password | length == 0\n\n    - name: \"Fail if SSH pre-flight check failed\"\n      ansible.builtin.fail:\n        msg: \"Pre-flight check failed. Could not establish SSH connection to {{ push_user }}@{{ push_host_port }}. Please ensure SSH access is correctly configured.\"\n      when: (push_password | length > 0 and ssh_check.rc != 0) or (push_password | length == 0 and ssh_check_key.rc != 0)\n\n    - name: \"1. Initialize Log Export and Extract Session ID\"\n      ansible.builtin.shell: >\n        fazbd-log-export init -Y '{ \"adom\": \"{{ export_adom }}\", \"log_type\": \"{{ export_log_type }}\", \"device_type\": \"{{ export_device_type }}\", \"device_ids\": {{ export_device_id | to_json }}, \"start_date\": \"{{ start_date }}\", \"end_date\": \"{{ end_date }}\", \"format\": \"{{ export_format }}\" }'\n      register: init_result\n      changed_when: false\n      failed_when: \"'Session ID:' not in init_result.stdout\"\n\n    - name: \"Display Init Result\"\n      ansible.builtin.debug:\n        msg: \"{{ init_result.stdout }}\"\n\n    - name: \"Set Session ID Fact\"\n      ansible.builtin.set_fact:\n        export_session_id: \"{{ init_result.stdout | regex_search('Session ID: ([a-zA-Z0-9]+)', '\\\\1') | first }}\"\n\n    - name: \"Display Session ID\"\n      ansible.builtin.debug:\n        msg: \"Session ID: {{ export_session_id }}\"\n\n    - name: \"2. Start Log Export Process\"\n      ansible.builtin.shell: \"nohup fazbd-log-export start {{ export_session_id }} --foreground > /tmp/export_{{ export_session_id }}.log 2>&1 &\"\n      register: start_result\n      changed_when: false\n\n    - name: \"Wait for export process to initialize\"\n      ansible.builtin.pause:\n        seconds: 5\n\n    - name: \"Display Start Result\"\n      ansible.builtin.debug:\n        msg: \"Export process started in background. Log file: /tmp/export_{{ export_session_id }}.log\"\n\n    - name: \"3. Wait for Log Export to Complete\"\n      ansible.builtin.shell: \"fazbd-log-export status {{ export_session_id }}\"\n      register: export_status\n      until: \"export_success_indicator in export_status.stdout and 'in progress' not in export_status.stdout\"\n      retries: \"{{ status_check_retries }}\"\n      delay: \"{{ status_check_delay }}\"\n      changed_when: false\n      failed_when: false\n\n    - name: \"Display Export Status\"\n      ansible.builtin.debug:\n        msg: \"{{ export_status.stdout }}\"\n\n    - name: \"Fail if Log Export did not complete\"\n      ansible.builtin.fail:\n        msg: \"Log export failed or timed out. Last status: {{ export_status.stdout }}\"\n      when: \"export_success_indicator not in export_status.stdout or 'in progress' in export_status.stdout\"\n\n    - name: \"4. Push Logs to Remote Server\"\n      ansible.builtin.shell: >\n        nohup fazbd-log-export push {{ export_session_id }} '{ \"protocol\": \"{{ push_protocol }}\", \"host_port\": \"{{ push_host_port }}\", \"user\": \"{{ push_user }}\", \"password\": \"{{ push_password }}\", \"directory\": \"{{ push_directory }}\" }' --foreground > /tmp/push_{{ export_session_id }}.log 2>&1 &\n      register: push_result\n      changed_when: false\n\n    - name: \"Wait for push process to initialize\"\n      ansible.builtin.pause:\n        seconds: 5\n\n    - name: \"Display Push Result\"\n      ansible.builtin.debug:\n        msg: \"Push process started in background. Log file: /tmp/push_{{ export_session_id }}.log\"\n\n    - name: \"5. Wait for Push to Complete by checking remote directory\"\n      ansible.builtin.shell: >\n        sshpass -p '{{ push_password }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ push_user }}@{{ push_host_port }}\n        'test -d \"{{ push_directory }}/fazbd-log-export-{{ export_session_id }}\" && \n         test -f \"{{ push_directory }}/fazbd-log-export-{{ export_session_id }}/export_info.txt\" && \n         echo \"push completed\"'\n      register: push_check\n      until: \"'push completed' in push_check.stdout\"\n      retries: \"{{ status_check_retries }}\"\n      delay: \"{{ status_check_delay }}\"\n      changed_when: false\n      failed_when: false\n      when: push_password | length > 0\n\n    - name: \"5. Wait for Push to Complete by checking remote directory (key-based)\"\n      ansible.builtin.shell: >\n        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ push_user }}@{{ push_host_port }}\n        'test -d \"{{ push_directory }}/fazbd-log-export-{{ export_session_id }}\" && \n         test -f \"{{ push_directory }}/fazbd-log-export-{{ export_session_id }}/export_info.txt\" && \n         echo \"push completed\"'\n      register: push_check_key\n      until: \"'push completed' in push_check_key.stdout\"\n      retries: \"{{ status_check_retries }}\"\n      delay: \"{{ status_check_delay }}\"\n      changed_when: false\n      failed_when: false\n      when: push_password | length == 0\n\n    - name: \"Fail if Push did not complete\"\n      ansible.builtin.fail:\n        msg: \"Push to remote server failed or timed out.\"\n      when: (push_password | length > 0 and 'push completed' not in push_check.stdout | default('')) or \n            (push_password | length == 0 and 'push completed' not in push_check_key.stdout | default(''))\n\n    - name: \"6. Move export directory into date-based parent directory on remote host\"\n      ansible.builtin.shell: >\n        sshpass -p '{{ push_password }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ push_user }}@{{ push_host_port }}\n        'cd {{ push_directory }} && \n         if [ -d \"fazbd-log-export-{{ export_session_id }}\" ]; then\n           mkdir -p \"fazbd-log-export-on-{{ export_date }}\";\n           mv \"fazbd-log-export-{{ export_session_id }}\" \"fazbd-log-export-on-{{ export_date }}/\";\n           echo \"Moved to fazbd-log-export-on-{{ export_date }}/fazbd-log-export-{{ export_session_id }}\";\n         else\n           echo \"Source directory not found\";\n         fi'\n      register: move_result\n      changed_when: \"'Moved' in move_result.stdout\"\n      when: push_password | length > 0\n\n    - name: \"6. Move export directory into date-based parent directory on remote host (key-based)\"\n      ansible.builtin.shell: >\n        ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ push_user }}@{{ push_host_port }}\n        'cd {{ push_directory }} && \n         if [ -d \"fazbd-log-export-{{ export_session_id }}\" ]; then\n           mkdir -p \"fazbd-log-export-on-{{ export_date }}\";\n           mv \"fazbd-log-export-{{ export_session_id }}\" \"fazbd-log-export-on-{{ export_date }}/\";\n           echo \"Moved to fazbd-log-export-on-{{ export_date }}/fazbd-log-export-{{ export_session_id }}\";\n         else\n           echo \"Source directory not found\";\n         fi'\n      register: move_result_key\n      changed_when: \"'Moved' in move_result_key.stdout\"\n      when: push_password | length == 0\n\n    - name: \"Display Move Result\"\n      ansible.builtin.debug:\n        msg: \"{{ move_result.stdout | default(move_result_key.stdout | default('N/A')) }}\"\n\n    - name: \"7. Verify Files on Remote Host\"\n      ansible.builtin.shell: \"sshpass -p '{{ push_password }}' ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ push_user }}@{{ push_host_port }} 'ls -lR {{ push_directory }}/fazbd-log-export-on-{{ export_date }}'\"\n      register: remote_files\n      changed_when: false\n      ignore_errors: true\n      when: push_password | length > 0\n\n    - name: \"7. Verify Files on Remote Host (key-based)\"\n      ansible.builtin.shell: \"ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null {{ push_user }}@{{ push_host_port }} 'ls -lR {{ push_directory }}/fazbd-log-export-on-{{ export_date }}'\"\n      register: remote_files_key\n      changed_when: false\n      ignore_errors: true\n      when: push_password | length == 0\n\n    - name: \"Display Remote File Listing\"\n      ansible.builtin.debug:\n        msg: \"Files on remote host {{ push_host_port }}:\\n{{ remote_files.stdout | default(remote_files_key.stdout | default('N/A')) }}\"\n\n    - name: \"8. Close and Clean Up Log Export Session\"\n      ansible.builtin.shell: \"fazbd-log-export force-stop {{ export_session_id }} 2>/dev/null || echo Y | fazbd-log-export close {{ export_session_id }}\"\n      register: close_result\n      changed_when: false\n      ignore_errors: true\n\n    - name: \"Display Close Result\"\n      ansible.builtin.debug:\n        msg: \"{{ close_result.stdout }}\"\n\n    - name: \"Clean up temporary log files\"\n      ansible.builtin.file:\n        path: \"{{ item }}\"\n        state: absent\n      loop:\n        - \"/tmp/export_{{ export_session_id }}.log\"\n        - \"/tmp/push_{{ export_session_id }}.log\"\n      ignore_errors: true\n\n    - name: \"Export Complete\"\n      ansible.builtin.debug:\n        msg: |\n          Export and push completed successfully!\n          Session {{ export_session_id }} has been closed.\n          Files exported to: {{ push_host_port }}:{{ push_directory }}/fazbd-log-export-on-{{ export_date }}\n",
    "playbook_vars" : "{}"
  }
} ]